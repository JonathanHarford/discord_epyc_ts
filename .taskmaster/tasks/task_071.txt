# Task ID: 71
# Title: Migrate from Direct Messages to Ephemeral Messages and Modals
# Status: pending
# Dependencies: 2, 10, 14, 47
# Priority: high
# Description: Replace the current DM-based game interaction system with ephemeral messages and modals for improved user experience and reliability.
# Details:
Update the MessageAdapter to prioritize ephemeral messages for game interactions. Refactor DirectMessageHandler logic to use the interaction handling framework (Task 47) for processing button clicks and modal submissions. Implement interaction handlers for turn notifications (ephemeral with buttons), ready command (ephemeral response), turn submissions (modal forms triggered by ephemeral prompts), and game communication (ephemeral error/status messages). Update TurnOfferingService to send ephemeral notifications. Ensure backward compatibility during the transition. Address benefits like eliminating 'Cannot send messages' errors, improving server context integration, enhancing UI/UX, and using a more reliable delivery mechanism.

**Current DM Usage Analysis**:
- Turn offering notifications (TurnOfferingService.sendTurnOfferDM)
- Turn request notifications (OnDemandTurnService.sendTurnRequestDM)
- Ready command processing (DirectMessageHandler.handleReadyCommand)
- Turn submission handling (DirectMessageHandler.handleTurnSubmission)
- Season completion announcements (when no channel configured)
- Error notifications and user feedback
- Game state updates and confirmations

**Specific Implementation Plan**:

**Phase 1: Simple Interactions**
- Convert ready commands → Ephemeral responses with action buttons
- Convert status checks → Ephemeral responses  
- Convert error messages → Ephemeral responses
- Update MessageAdapter.processInstruction to prefer ephemeral over DM

**Phase 2: Complex Interactions**
- Turn submissions → Modal-based forms for text, ephemeral prompts for images
- Game configuration → Already using modals (leverage existing patterns)
- Convert DirectMessageHandler logic to interaction handlers

**Phase 3: Hybrid Notification System**
- Keep minimal "ping" DMs like "Your turn is ready in #game-channel"
- All actual interaction happens via ephemeral/modals
- Update TurnOfferingService to use ephemeral notifications

**Technical Implementation Details**:
- Leverage existing ephemeral message infrastructure (already extensive)
- Utilize existing modal system for admin/season creation (good foundation)
- Adapt existing button/interaction handlers
- Update MessageInstruction system for ephemeral preference
- Handle image submission complexity with ephemeral prompts directing to slash commands with file attachments
- Address modal character limits (encourages better UX)
- Implement notification system to guide users to correct server/channel

# Test Strategy:
Unit tests for individual interaction handlers and MessageAdapter logic. Integration tests to verify end-to-end flows for turn offering (ephemeral + buttons), ready command (ephemeral), and turn submissions (ephemeral prompt + modal). Test that error and status messages are sent ephemerally in the correct channel context. Manual testing by playing through games using the new flow, testing all interaction types and edge cases. Verify backward compatibility if applicable.

**Specific Test Cases**:
1. Test MessageAdapter's preference for ephemeral messages over DMs
2. Verify ready command interaction handlers produce correct ephemeral responses with action buttons
3. Test turn submission flow with modal forms and ephemeral prompts for images
4. Validate hybrid notification system (minimal DM pings + ephemeral interactions)
5. Test error handling and status updates via ephemeral messages
6. Verify image submission flow with ephemeral prompts → slash commands
7. Test character limit handling in modals
8. Verify notification system guides users to correct server/channel

**Files to Test**:
- src/messaging/MessageAdapter.ts
- src/events/direct-message-handler.ts (and new interaction handlers)
- src/services/TurnOfferingService.ts
- src/services/OnDemandTurnService.ts
- src/utils/modalBuilders.ts

# Subtasks:
## 71.1. Update MessageAdapter for Ephemeral Preference [pending]
### Dependencies: None
### Description: Modify MessageAdapter.processInstruction to prefer ephemeral messages over DMs when interaction context is available.
### Details:


## 71.2. Implement Phase 1: Simple Interactions [pending]
### Dependencies: None
### Description: Convert ready commands, status checks, and error messages to use ephemeral responses.
### Details:


## 71.3. Implement Phase 2: Complex Interactions [pending]
### Dependencies: None
### Description: Create modal-based forms for turn submissions and convert DirectMessageHandler logic to interaction handlers.
### Details:


## 71.4. Implement Phase 3: Hybrid Notification System [pending]
### Dependencies: None
### Description: Develop a hybrid approach with minimal DM pings and ephemeral/modal interactions. Update TurnOfferingService and OnDemandTurnService.
### Details:


## 71.5. Create Image Submission Flow [pending]
### Dependencies: None
### Description: Implement ephemeral prompts that direct users to slash commands with file attachments for image submissions.
### Details:


## 71.6. Implement Notification Guidance System [pending]
### Dependencies: None
### Description: Create a system to guide users to the correct server/channel for interactions.
### Details:


## 71.7. Update Turn Submission Modal Builders [pending]
### Dependencies: None
### Description: Create or update modal builders to handle turn submissions with appropriate character limits and UX considerations.
### Details:


## 71.8. Comprehensive Testing [pending]
### Dependencies: None
### Description: Perform unit, integration, and manual testing of all interaction flows and edge cases.
### Details:


