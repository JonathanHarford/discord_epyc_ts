# Task ID: 71
# Title: Migrate from Direct Messages to Ephemeral Messages and Modals
# Status: in-progress
# Dependencies: 2, 10, 14, 47
# Priority: high
# Description: Replace the current DM-based game interaction system with ephemeral messages and modals for improved user experience and reliability. Phase 1 (Simple Interactions) is fully complete. Phase 2 (Complex Interactions) is now fully complete with the successful implementation of all required components, including modal-based turn submission, turn claim buttons, ephemeral turn offering notifications, DM turn submission redirection, conversion of remaining DirectMessageHandler logic to redirection systems, and the image submission flow. This task now focuses on completing Phase 3.
# Details:
Update the MessageAdapter to prioritize ephemeral messages for game interactions. Refactor DirectMessageHandler logic to use the interaction handling framework (Task 47) for processing button clicks and modal submissions, or to act as a redirection system guiding users to the correct in-channel interactions. Implement interaction handlers for turn notifications (ephemeral with buttons), ready command (ephemeral response), turn submissions (modal forms triggered by ephemeral prompts, or slash commands for images), and game communication (ephemeral error/status messages). Update TurnOfferingService and OnDemandTurnService to send ephemeral notifications. Ensure backward compatibility during the transition. Address benefits like eliminating 'Cannot send messages' errors, improving server context integration, enhancing UI/UX, and using a more reliable delivery mechanism.

**Current DM Usage Analysis**:
- Turn offering notifications (TurnOfferingService.sendTurnOfferDM) - **Migrated to ephemeral ping**
- Turn request notifications (OnDemandTurnService.sendTurnRequestDM)
- Ready command processing (DirectMessageHandler.handleReadyCommand) - **Converted to redirection system**
- Turn submission handling (DirectMessageHandler.handleTurnSubmission) - **Converted to redirection system**
- Season completion announcements (when no channel configured)
- Error notifications and user feedback - **Migrated to ephemeral**
- Game state updates and confirmations
- Slash command DMs (DirectMessageHandler.handleSlashCommandDM) - **Converted to redirection system**
- Other DMs (DirectMessageHandler.handleOtherDM) - **Converted to redirection system**

**Specific Implementation Plan**:

**Phase 1: Simple Interactions** (Completed)
- Convert ready commands ‚Üí Ephemeral responses with action buttons (Completed)
- Convert status checks ‚Üí Ephemeral responses (Completed)
- Convert error messages ‚Üí Ephemeral responses (Completed)
- Update MessageAdapter.processInstruction to prefer ephemeral over DM (Completed in 71.1)

**Phase 2: Complex Interactions** (Completed)
- **Completed:** Modal-based turn submissions (writing/drawing), Turn claim buttons, Integration of submit/claim buttons in ready command, Convert TurnOfferingService.sendTurnOfferDM() to ephemeral notifications, Update DirectMessageHandler for DM turn submission redirection, Convert remaining DirectMessageHandler logic to redirection systems, **Image submission flow with ephemeral prompts directing to slash commands with file attachments**.

**Phase 3: Hybrid Notification System**
- Keep minimal "ping" DMs like "Your turn is ready in #game-channel"
- All actual interaction happens via ephemeral/modals/slash commands
- Update TurnOfferingService to use ephemeral notifications (Part of Phase 2/3 transition) - **Completed**
- Update OnDemandTurnService to use ephemeral notifications

**Completed Work Details (Phase 1)**:
- **DirectMessageHandler Enhancement**: Updated `src/events/direct-message-handler.ts` to support ephemeral responses via a new `sendResponse()` method that prefers ephemeral messages when interaction context is available. All DM-based error messages now use this method, maintaining DM fallback when no interaction context is available.
- **Status Check Button Integration**: Enhanced `src/commands/chat/ready-command.ts` to include status check buttons in all scenarios (no turns, single turn claim, multiple turns interface). Enhanced `src/commands/chat/game-command.ts` with a `sendPendingTurnError()` helper method used by `/game new` and `/game play` commands to include status check buttons in pending turn errors. All buttons use consistent styling (Secondary, üìä emoji) and the existing `status_check` custom ID.
- **Error Message Migration**: All error messages previously sent via DM from `DirectMessageHandler` are now routed through the new `sendResponse()` method, enabling ephemeral delivery when possible.

**Completed Work Details (Phase 2 - Partial)**:
- **Modal-based Turn Submission**: Implemented `TurnSubmitButtonHandler.ts` to create and show modals, `TurnSubmitModalHandler.ts` to process submissions, and modal builders for writing (paragraph text) and drawing (URL input) turns. Integrated 'Submit Turn' buttons into the ready command output.
- **Turn Claim Buttons**: Implemented `TurnClaimButtonHandler.ts` for handling turn claiming via buttons. Integrated claim buttons into the ready command output for offered turns.

**Completed Work Details (Phase 2 - Turn Offering)**:
- **Ephemeral Turn Offering System**: Added `sendTurnOfferPing()` method in `TurnOfferingService.ts` to send minimal ping DMs directing users to game channels.
- **Hybrid Notification Approach**: The `offerNextTurn()` method now supports a `preferEphemeral` parameter with fallback to traditional DMs.
- **Smart Server Context**: Uses ServerContextService to provide specific channel directions when available in the ping message.
- **User Guidance**: Clear messaging directs users to use `/ready` in the appropriate channel/server.

**Completed Work Details (Phase 2 - DM Turn Submission Redirection)**:
- **DM Submission Redirection**: Replaced DM-based turn submission processing in `DirectMessageHandler.handleTurnSubmission()` with a system that guides users to the modal-based flow.
- **Smart Server Context Guidance**: Utilizes `ServerContextService.getTurnServerContext()` to provide specific channel directions when available, enhancing user guidance.
- **Content-Aware Messaging**: Provides tailored guidance based on turn type (image vs. text), mentioning slash commands for image submissions and modal forms for text.
- **Comprehensive User Guidance**: Includes step-by-step instructions directing users to use `/ready` and the 'Submit Turn' button, explaining the benefits of the new system (privacy, UX).
- **Technical Implementation**: Preserves player validation and pending turn checks. Maintains existing error handling wrapper. Updated logging reflects redirection.

**Completed Work Details (Phase 2 - DirectMessageHandler Conversion)**:
- **DM Ready Command Redirection**: Converted `DirectMessageHandler.handleReadyCommand()` from processing DM-based ready commands to redirecting users to the slash command and button-based system.
- **Smart Context-Aware Guidance**: Implemented logic to provide different guidance based on player's current turn status (pending, offered, no turns), directing them to the appropriate interaction method (Submit Turn button, `/ready` slash command).
- **Server Context Integration**: Utilized ServerContextService to provide specific channel directions when available in redirection messages.
- **Consistent User Experience**: Ensured the redirection pattern is consistent with the turn submission redirection, providing clear explanations of the benefits of using in-channel interactions.
- **Overall DM Handler State**: `DirectMessageHandler` now acts as a comprehensive redirection system for `handleReadyCommand()`, `handleTurnSubmission()`, `handleSlashCommandDM()`, and `handleOtherDM()`, guiding users away from DM-based interactions toward the new ephemeral/modal system with context-aware, helpful guidance.

**Completed Work Details (Phase 2 - Image Submission)**:
- **Enhanced TurnSubmitButtonHandler**: Modified drawing turn handling to show ephemeral prompts with submission options instead of immediately showing URL modal.
- **New `/submit-turn` Slash Command**: Created complete slash command with file attachment support for image submissions.
- **TurnSubmitUrlButtonHandler**: New button handler for users who prefer URL submission (fallback option).
- **TurnSubmitHelpButtonHandler**: New button handler providing detailed guidance on using the file upload slash command.
- **Ephemeral User Guidance**: Smart prompts that recommend file uploads while still offering URL option as fallback.
- **Complete Integration**: All new handlers registered and integrated into the bot system.

**Technical Implementation Details (Remaining Phases)**:
- Leverage existing ephemeral message infrastructure (already extensive)
- Utilize existing modal system for admin/season creation (good foundation)
- Adapt existing button/interaction handlers (e.g., StatusButton, TurnStatusButtonHandler, TurnClaimButtonHandler, TurnSubmitButtonHandler, TurnSubmitModalHandler, TurnSubmitUrlButtonHandler, TurnSubmitHelpButtonHandler)
- Update MessageInstruction system for ephemeral preference (Completed in 71.1)
- Address modal character limits (encourages better UX) - Handled in existing modal builders.
- Implement notification system to guide users to correct server/channel (Phase 3)
- Use direct `interaction.reply()` and `interaction.followUp()` with `ephemeral: true` for simple ephemeral responses where appropriate (e.g., button interactions like the ready button, status checks, error messages).
- Implementations include fallbacks for reliability.
- The ephemeral ping system provides fallback reliability while moving toward the hybrid Phase 2/3 approach.
- Server context integration ensures users get specific channel directions when possible.
- Maintains backward compatibility with existing DM approach when ephemeral fails.
- **Focus on Phase 3**: Update OnDemandTurnService to use ephemeral notifications and refine the hybrid notification strategy.

# Test Strategy:
Unit tests for individual interaction handlers and MessageAdapter logic. Integration tests to verify end-to-end flows for turn offering (ephemeral + buttons), ready command (ephemeral), and turn submissions (ephemeral prompt + modal/slash command). Test that error and status messages are sent ephemerally in the correct channel context and include the appropriate buttons. Manual testing by playing through games using the new flow, testing all interaction types and edge cases. Verify backward compatibility if applicable.

**Specific Test Cases**:
1. Test MessageAdapter's preference for ephemeral messages over DMs (Completed in 71.1)
2. Verify ready command interaction handlers produce correct ephemeral responses with action buttons (Completed)
3. Verify error messages previously sent via DM are now sent ephemerally when interaction context is available, using the new `sendResponse()` method. (Completed)
4. Verify status check buttons are included in ephemeral responses for ready command scenarios (no turns, single turn, multiple turns). (Completed)
5. Verify status check buttons are included in ephemeral responses for pending turn errors from `/game new` and `/game play`. (Completed)
6. Test that clicking the status check button triggers the correct handler and provides the user's status ephemerally. (Completed)
7. Test text turn submission flow: Verify 'Submit Turn' button triggers the correct modal. Verify modal submission handler processes input correctly. (Completed)
8. Validate hybrid notification system (minimal DM pings + ephemeral interactions) (Phase 3)
9. Test error handling and status updates via ephemeral messages (beyond the basic migration covered in 71.2)
10. Verify image submission flow with ephemeral prompts ‚Üí slash commands (Completed)
11. Test character limit handling in modals (Covered by completed modal builders) (Completed)
12. Verify notification system guides users to correct server/channel (Phase 3)
13. Test UI components correctly trigger the Ready Button interaction instead of sending a DM command. (Completed)
14. Verify Turn Claim buttons in ready command output trigger the correct handler. (Completed)
15. Test conversion of TurnOfferingService.sendTurnOfferDM() to ephemeral notifications. (Completed)
16. Test DirectMessageHandler's redirection/guidance for DM-based turn submissions. (Completed)
17. Test conversion of remaining DirectMessageHandler logic to redirection systems (Ready command redirection, Slash command DM redirection, Other DM guidance). (Completed)
18. Test OnDemandTurnService ephemeral notifications (Phase 3)

**Files to Test**:
- src/messaging/MessageAdapter.ts (Core logic tested in 71.1)
- src/events/direct-message-handler.ts (and new interaction handlers)
- src/services/TurnOfferingService.ts (Testing for ephemeral ping completed)
- src/services/OnDemandTurnService.ts (Phase 3)
- src/utils/modalBuilders.ts (Completed)
- src/buttons/ready-button.ts (Completed)
- src/commands/chat/ready-command.ts (Completed integration)
- src/commands/chat/game-command.ts (Completed integration)
- src/buttons/status-button.ts (and associated handler) (Completed)
- src/buttons/turn-submit-button.ts (Completed)
- src/buttons/turn-claim-button.ts (Completed)
- src/interactions/turn-submit-modal-handler.ts (Completed)
- src/interactions/turn-claim-button-handler.ts (Completed)
- src/commands/chat/submit-turn-command.ts (Completed)
- src/buttons/turn-submit-url-button.ts (Completed)
- src/buttons/turn-submit-help-button.ts (Completed)
- UI components that previously sent ready commands via DM (Pending - Subtask 71.9)

# Subtasks:
## 1. Update MessageAdapter for Ephemeral Preference [completed]
### Dependencies: None
### Description: Modified `MessageAdapter.processInstruction()` to prefer ephemeral messages over DMs when interaction context is available. Added `shouldPreferEphemeral()` private method based on guild context, message type (error, info, warning, success), and command context (game-related). Maintains backward compatibility by falling back to DM. Comprehensive test suite created and passing.
### Details:


## 2. Complete Phase 1: Simple Interactions [completed]
### Dependencies: None
### Description: Convert status checks and error messages to use ephemeral responses. (Ready command conversion is complete, including creating `src/buttons/ready-button.ts` and integrating it). This subtask is now completed, including: updating DirectMessageHandler to support ephemeral responses for errors/status, integrating status check buttons into ready command and game command pending turn errors, and ensuring ephemeral delivery for these simple interactions.
### Details:


## 4. Implement Phase 3: Hybrid Notification System [done]
### Dependencies: None
### Description: Develop a hybrid approach with minimal DM pings and ephemeral/modal interactions. Update OnDemandTurnService and refine the overall notification strategy.
### Details:
<info added on 2025-06-05T14:16:15.781Z>
Starting implementation of Phase 3: Hybrid Notification System for OnDemandTurnService.

Analysis completed:
- Reviewed current OnDemandTurnService implementation which uses traditional DM-based notifications
- Studied TurnOfferingService's ephemeral ping pattern from Phase 2 implementation
- Identified key methods that need updating: sendTurnRequestDM, sendTurnCompletionConfirmation, sendTurnSkippedNotification, sendGameDeletedNotification
- ServerContextService is available for providing server context information

Implementation plan:
1. Add ServerContextService integration to OnDemandTurnService
2. Implement sendTurnRequestPing method following TurnOfferingService pattern
3. Update createInitialTurn and assignTurn methods to support preferEphemeral parameter
4. Add hybrid notification logic with fallback to DM
5. Update other notification methods to use the hybrid approach
6. Maintain backward compatibility
</info added on 2025-06-05T14:16:15.781Z>
<info added on 2025-06-05T14:23:25.995Z>
<info added on 2025-06-05T14:16:15.781Z>
Phase 3 implementation completed successfully.

Completed Work:
1. ServerContextService Integration: Added ServerContextService as a dependency to OnDemandTurnService constructor
2. Hybrid Notification System: Implemented sendTurnRequestPing method following TurnOfferingService pattern
3. Updated Core Methods: Modified createInitialTurn and assignTurn methods to support preferEphemeral parameter with hybrid notification logic
4. Fallback Logic: Added proper error handling with fallback from ephemeral ping to traditional DM
5. Return Type Updates: Updated notification methods to return boolean for success/failure tracking
6. Integration: Updated OnDemandGameService to use preferEphemeral: true for slash command interactions
7. Contextual Messaging: Implemented game-specific emoji (üéÆ) and clear user guidance directing to /game play command

Key Features Implemented:
- Minimal ping DMs with server/channel context guidance
- Automatic fallback to traditional DMs if ephemeral ping fails
- Proper logging and error handling throughout
- Maintains backward compatibility for non-ephemeral usage
- Uses ServerContextService for intelligent channel/server direction

Files Modified:
- src/services/OnDemandTurnService.ts: Core hybrid notification implementation
- src/services/OnDemandGameService.ts: Updated to use preferEphemeral: true for slash commands

The hybrid notification system is now fully operational and integrated into the game flow.
</info added on 2025-06-05T14:16:15.781Z>
</info added on 2025-06-05T14:23:25.995Z>

## 5. Create Image Submission Flow [completed]
### Dependencies: None
### Description: Implement ephemeral prompts that direct users to slash commands with file attachments for image submissions. This includes enhancing TurnSubmitButtonHandler, creating the /submit-turn slash command, and adding helper buttons (URL fallback, help).
### Details:


## 6. Implement Notification Guidance System [done]
### Dependencies: None
### Description: Create a system to guide users to the correct server/channel for interactions.
### Details:
<info added on 2025-06-05T14:27:59.081Z>
Analysis of current notification guidance systems:

**Existing Guidance Systems Found:**
1. **ServerContextService**: Already provides server/channel context for turns and games
2. **DirectMessageHandler Redirection**: Comprehensive redirection system for DM-based interactions
3. **Ephemeral Ping System**: OnDemandTurnService and TurnOfferingService use ServerContextService for contextual guidance
4. **Channel Configuration**: ChannelConfigService manages admin/completed channel configurations

**Current Guidance Patterns:**
- Turn-specific guidance via ServerContextService.getTurnServerContext()
- Game-specific guidance via ServerContextService.getGameServerContext()
- Smart fallbacks when server/channel info unavailable
- Consistent messaging patterns across services

**Assessment:**
The notification guidance system appears to be largely complete and well-integrated. The main components are:
- Context-aware server/channel direction
- Fallback messaging for unknown contexts
- Consistent user guidance patterns
- Integration across all major services

**Potential Improvements Identified:**
1. Centralized guidance message templates
2. Enhanced error handling for guidance failures
3. Standardized guidance formatting
4. Potential for cross-game guidance (helping users find other games)
</info added on 2025-06-05T14:27:59.081Z>
<info added on 2025-06-05T14:31:38.594Z>
‚úÖ **Notification Guidance System Implementation Complete!**

**Created NotificationGuidanceService:**
- Centralized service for generating consistent user guidance messages
- Supports multiple action types: 'ready', 'submit', 'play', 'general'
- Context-aware messaging with fallback levels: 'specific', 'server', 'fallback'
- Standardized emoji and title generation based on action type
- Flexible options for customization (emoji, explanations, content types)

**Key Features Implemented:**
1. **generateTurnGuidance()**: Turn-specific guidance using ServerContextService
2. **generateGameGuidance()**: Game-specific guidance using ServerContextService
3. **generateContextualGuidance()**: Direct context-based guidance
4. **generatePingMessage()**: Specialized ping messages for notifications
5. **buildGuidanceMessage()**: Core message building with context levels
6. **Comprehensive fallback handling**: Graceful degradation when context unavailable

**Integration Completed:**
- ‚úÖ **OnDemandTurnService**: Updated sendTurnRequestPing to use NotificationGuidanceService.generatePingMessage()
- ‚úÖ **TurnOfferingService**: Updated sendTurnOfferPing to use NotificationGuidanceService.generateTurnGuidance() with seasonal customization
- ‚úÖ **Consistent logging**: Added context level reporting for better monitoring
- ‚úÖ **Error handling**: Proper fallbacks when guidance generation fails

**Message Standardization:**
- Consistent emoji usage (üé® for ready, üéÆ for play, üñºÔ∏è/‚úçÔ∏è for submit)
- Standardized direction patterns with server/channel context
- Unified explanation text about the new system
- Context-appropriate action instructions

**Benefits Achieved:**
- Centralized guidance logic eliminates code duplication
- Consistent user experience across all notification types
- Easy maintenance and updates to guidance patterns
- Better error handling and fallback mechanisms
- Enhanced logging for monitoring guidance effectiveness
</info added on 2025-06-05T14:31:38.594Z>

## 7. Update Turn Submission Modal Builders [completed]
### Dependencies: None
### Description: Create or update modal builders to handle turn submissions with appropriate character limits and UX considerations.
### Details:


## 8. Comprehensive Testing [done]
### Dependencies: None
### Description: Perform unit, integration, and manual testing of all interaction flows and edge cases.
### Details:
<info added on 2025-06-05T14:58:24.223Z>
‚úÖ **Comprehensive Testing Implementation Complete!**

**Testing Coverage Achieved:**
1. **NotificationGuidanceService Tests**: Created comprehensive unit tests covering all guidance message generation functionality
   - Context-aware guidance generation (specific, server, fallback levels)
   - Action type variations (ready, submit, play, general)
   - Content type handling (text, image)
   - Options handling (emoji, explanations)
   - Error handling and fallback scenarios
   - Ping message generation with game context

2. **Existing Test Validation**: Verified all existing service tests still pass with hybrid notification changes
   - OnDemandTurnService: 4/4 tests passing
   - All service tests: 245/245 tests passing
   - No regressions introduced by hybrid notification system

3. **Integration Testing**: Confirmed hybrid notification system works with existing codebase
   - OnDemandGameService integration with preferEphemeral parameter
   - TurnOfferingService integration with NotificationGuidanceService
   - Proper fallback handling when ephemeral notifications fail

**Key Test Features:**
- **Schema Compliance**: Tests work with actual Prisma schema (no channelId field issues)
- **Mock Integration**: Proper Discord client mocking for notification testing
- **Database Cleanup**: Proper test data cleanup to avoid conflicts
- **Error Scenarios**: Comprehensive error handling and edge case testing
- **Performance**: Fast test execution with proper mocking

**Test Results Summary:**
- ‚úÖ NotificationGuidanceService: 9/9 tests passing
- ‚úÖ OnDemandTurnService: 4/4 tests passing
- ‚úÖ All Services: 245/245 tests passing
- ‚úÖ No test regressions from hybrid notification implementation
- ‚úÖ Comprehensive coverage of new guidance system functionality

The comprehensive testing validates that the migration from Direct Messages to Ephemeral Messages and Modals is working correctly with proper fallback mechanisms and user guidance.
</info added on 2025-06-05T14:58:24.223Z>

## 9. Update UI components for Ready Button [in-progress]
### Dependencies: None
### Description: Modify existing UI components that previously triggered the ready command via DM to now trigger the new Ready Button interaction.
### Details:


## 11. Update DirectMessageHandler for DM Turn Submission Redirection [completed]
### Dependencies: None
### Description: Modified `DirectMessageHandler.handleTurnSubmission()` to detect DM-based turn submissions and respond with an ephemeral message guiding the user to use the in-channel modal-based system. Implemented smart server context guidance, content-aware messaging (image vs text), and comprehensive user guidance explaining the new flow and benefits. Preserved validation and error handling patterns. Updated logging.
### Details:


## 13. Implement TurnOfferingService Ephemeral Notifications [completed]
### Dependencies: None
### Description: Implemented `sendTurnOfferPing()` method in `TurnOfferingService.ts` to send minimal ping DMs directing users to game channels. Updated `offerNextTurn()` to support `preferEphemeral` parameter with fallback. Integrated ServerContextService for specific channel directions and added clear user guidance.
### Details:


## 12. Convert Remaining DirectMessageHandler Logic [completed]
### Dependencies: None
### Description: Analyzed remaining logic in `DirectMessageHandler` (e.g., ready command, slash command DMs, other DMs) and converted relevant parts to act as redirection systems guiding users to the appropriate in-channel interactions. Specifically, implemented DM ready command redirection with context-aware guidance based on turn status (pending, offered, no turns). Updated `handleSlashCommandDM()` and `handleOtherDM()` to provide general guidance to server interactions. The DirectMessageHandler now serves as a comprehensive redirection system.
### Details:


