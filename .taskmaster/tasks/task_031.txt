# Task ID: 31
# Title: Refactor /new season Command to Use Lang Service
# Status: done
# Dependencies: 30
# Priority: medium
# Description: The '/new season' subcommand handler in src/commands/chat/new-command.ts has been successfully refactored to utilize the Lang service and the new messaging layer for all user-facing messages, based on structured instructions from SeasonService.
# Details:
This task involved modifying the `/new season` command handler located in `src/commands/chat/new-command.ts` to eliminate direct string construction of user feedback messages and instead rely entirely on the `Lang` service and the new `MessageAdapter`.

**Implementation Completed:**

1.  **MessageAdapter Integration**: The command now uses `MessageAdapter.processInstruction()` for all user-facing messages (replies, follow-ups, DMs, errors).
2.  **Structured MessageInstructions**: All messages are handled via `MessageInstruction` objects received from `SeasonService`, containing `type`, `key`, and `data` fields.
3.  **Language Keys Defined**: All necessary language keys for `/new season` messages have been defined in `lang/lang.en-US.json` (and other language files) under the `refs.newCommand.season.*` namespace.
4.  **Constants Usage**: Language keys are properly referenced using the `LangKeys.Commands.New.*` constants from `src/constants/lang-keys.ts`.
5.  **Error Mapping**: Service error keys returned by `SeasonService` are properly mapped to command-specific language keys for user-friendly error messages.
6.  **No Direct String Construction**: All instances of direct string message construction or concatenation intended for user output within the command handler have been eliminated.
7.  **Proper Architecture**: The command handler uses injected dependencies (like `SeasonService`) and does not instantiate `PrismaClient` directly, adhering to architectural principles.

**Key Features Implemented:**

*   Successful season creation messages with dynamic data (seasonId, mentionUser, openDuration) are correctly generated and sent via the messaging layer.
*   Comprehensive error handling for validation errors, database errors, and unknown errors is implemented, using the messaging layer to provide informative, ephemeral error messages.
*   Player creation/lookup logic within the command correctly integrates with the messaging layer for feedback and errors.
*   Service error keys are effectively mapped to appropriate command-level language keys.

# Test Strategy:
Testing of the refactored `/new season` command has been completed in a development environment, confirming successful implementation.

**Testing Confirmed:**

1.  **Successful Season Creation:** Verified that executing the command with valid parameters results in a correctly formatted success message (reply or embed) originating from the `Lang` service via the `MessageAdapter`, including expected dynamic data (season name, ID, dates) correctly populated from the `MessageInstruction`.
2.  **Validation Errors:** Verified that executing the command with invalid parameters triggers appropriate validation errors from `SeasonService`, and the command handler correctly uses the messaging layer to display informative, ephemeral error messages originating from the `Lang` service with relevant placeholders filled.
3.  **Service Interaction Errors:** Verified that potential errors during the `SeasonService.createSeason` call are caught and handled, with user-friendly error messages generated via the messaging layer using appropriate language keys and placeholders.
4.  **Placeholder Verification:** Confirmed that for all message types (success, various errors), all intended placeholders (e.g., `{seasonName}`, `{seasonId}`, `{errorDetail}`) are correctly replaced with actual data in the final message output.
5.  **Code Inspection:** Confirmed via code review that `src/commands/chat/new-command.ts` contains no direct string concatenation or hardcoded message strings intended for user output and does not instantiate `PrismaClient`.
6.  **Language File Verification:** Confirmed that new keys for `/new season` messages have been added to the language files (`lang.*.json`) under `refs.newCommand.season.*` and are correctly structured with placeholders.
