# Task ID: 37
# Title: Implement Timeout Configuration Integration from Season Config
# Status: done
# Dependencies: 1, 5, 10, 14
# Priority: high
# Description: Integrate season-specific timeout values into TurnOfferingService and direct-message-handler.ts to replace hardcoded values.
# Details:
This task involves replacing hardcoded timeout durations in key parts of the application with values dynamically loaded from the active season's configuration settings.  Specifically:

1.  Identify the mechanism for accessing the current season's configuration parameters (e.g., via `SeasonService`, `GameService`, or directly from the database context associated with a turn).
2.  Modify `src/services/TurnOfferingService.ts`:
    -   Locate the hardcoded timeout values (referenced around lines 186 and 211 in the prompt's context).
    -   Replace these hardcoded numbers with logic that retrieves the appropriate 'claim_timeout' duration from the current season's configuration.
3.  Modify `src/handlers/direct-message-handler.ts`:
    -   Locate the hardcoded timeout value (referenced around line 166 in the prompt's context).
    -   Replace this hardcoded number with logic that retrieves the appropriate 'submission_timeout' duration (either writing or drawing, depending on the turn type) from the current season's configuration.
4.  Ensure robust error handling or fallback mechanisms are in place if season configuration values are missing or invalid (e.g., use a sensible default).

# Test Strategy:
1.  Unit tests for `TurnOfferingService` and `direct-message-handler.ts` mocking the configuration retrieval to ensure the correct configured values are used.
2.  Integration tests:
    -   Create a season with explicitly set, non-default `claim_timeout` and `submission_timeout` values.
    -   Trigger the turn offering mechanism for a turn in this season and verify that the scheduled claim timeout matches the configured value.
    -   Have a player claim a turn (writing or drawing) in this season and verify that the scheduled submission timeout matches the configured value.
    -   Repeat tests with different season configurations to confirm values are loaded correctly per season.
3.  Test edge cases, such as seasons created without explicit timeout configurations (should fall back to defaults if implemented).

# Subtasks:
## 1. Implement Season Timeout Retrieval Utility [done]
### Dependencies: None
### Description: Create a utility function or service method responsible for retrieving season-specific timeout values (claim, submission_writing, submission_drawing) given a context that allows access to the current season (e.g., a Turn or Game object). This utility must implement robust error handling and fall back to sensible default values if the season configuration or specific timeout keys are missing or invalid.
### Details:
Identify the appropriate place for this utility (e.g., a new `SeasonConfigService` or a method within an existing service like `GameService`). The function should accept a parameter (like a `Turn` or `Game` object) from which the season can be determined. Access the season's configuration data. Extract `claim_timeout`, `submission_timeout_writing`, and `submission_timeout_drawing`. If any value is missing or not a valid number, return a predefined sensible default for that specific timeout type. Consider creating constants for default timeout values.
<info added on 2025-05-25T16:48:42.735Z>
User Plan:
1. Create a new utility file `src/utils/seasonConfig.ts` with a function to get timeout values.
2. The function will accept a turn ID and return parsed timeout values in minutes.
3. Include proper error handling with fallback to sensible defaults.
4. Use the existing `parseDuration` utility to convert duration strings to minutes.
</info added on 2025-05-25T16:48:42.735Z>
<info added on 2025-05-25T16:49:37.322Z>
✅ Completed. Created `src/utils/seasonConfig.ts` with the `getSeasonTimeouts(prisma, turnId)` utility function. This function retrieves season-specific timeout values (claim, writing, drawing) by querying turn -> game -> season -> config. It uses the existing `parseDuration` utility to convert duration strings to minutes, includes robust error handling with fallbacks to sensible defaults (24h for claim/writing, 72h for drawing), and provides comprehensive logging. A type-safe interface `SeasonTimeouts` is used for the return values. The function accepts a turn ID and Prisma client and returns timeout values in minutes. Ready to proceed with integration into `TurnOfferingService`.
</info added on 2025-05-25T16:49:37.322Z>

## 2. Integrate Season Config into TurnOfferingService for Claim Timeout [done]
### Dependencies: 37.1
### Description: Modify `src/services/TurnOfferingService.ts` to replace hardcoded claim timeout values with the dynamic value retrieved using the utility implemented in subtask 1. This affects the logic determining how long a turn offer is available for claiming.
### Details:
Locate the hardcoded timeout values related to turn claiming (referenced around lines 186 and 211 in the original context). Inject or access the utility/service created in subtask 1. Before setting the claim expiration time, call the utility with the relevant context (likely the `Turn` object being offered) to get the `claim_timeout` value. Use this retrieved value instead of the hardcoded number. Ensure the code handles potential errors from the utility (though the utility should provide defaults, defensive coding is good practice).
<info added on 2025-05-25T16:49:47.547Z>
Import the `getSeasonTimeouts` utility created in subtask 1. Locate the hardcoded `claimTimeoutMinutes = 1440` value within the `TurnOfferingService`. Replace this hardcoded value by calling the imported `getSeasonTimeouts` utility with the appropriate context (likely the `Turn` object) to retrieve the season-specific `claim_timeout`. Update the `scheduleClaimTimeout` method to use this dynamically retrieved timeout value. Ensure proper error handling is in place in case the utility call fails, falling back to a default value if necessary.
</info added on 2025-05-25T16:49:47.547Z>
<info added on 2025-05-25T16:50:51.468Z>
✅ Completed. Integrated the `getSeasonTimeouts` utility into `TurnOfferingService`. The `sendTurnOfferDM` method was updated to use the season-specific claim timeout in the DM message text, and the `scheduleClaimTimeout` method was updated to use the dynamic timeout value for scheduling the timeout date. The hardcoded 1440 value has been replaced. Implemented fallback to default timeout (24 hours) if season config is missing or invalid. Ready to proceed to subtask 3.
</info added on 2025-05-25T16:50:51.468Z>

## 3. Integrate Season Config into DirectMessageHandler for Submission Timeout [done]
### Dependencies: 37.1
### Description: Modify `src/handlers/direct-message-handler.ts` to replace the hardcoded submission timeout value with the dynamic value retrieved using the utility implemented in subtask 1. This affects the logic determining the deadline for players to submit their drawing or writing.
### Details:
Locate the hardcoded timeout value related to submission deadlines (referenced around line 166 in the original context). Inject or access the utility/service created in subtask 1. When calculating the submission deadline for a turn, call the utility with the relevant context (likely the `Turn` object). Based on the `turn.type` (drawing or writing), use either the `submission_timeout_drawing` or `submission_timeout_writing` value returned by the utility. Use this retrieved value instead of the hardcoded number. Ensure the code handles potential errors.
<info added on 2025-05-25T16:55:41.650Z>
✅ IMPLEMENTATION COMPLETED

Successfully integrated season config into DirectMessageHandler for submission timeouts:

**Changes Made:**
1. **Added Import**: Added `getSeasonTimeouts` import from `../utils/seasonConfig.js`

2. **Replaced Hardcoded Logic**: Updated the submission timeout calculation in `handleReadyCommand` method:
   - **Before**: `const submissionTimeoutMinutes = turnToClaim.type === 'WRITING' ? 1440 : 4320;`
   - **After**:
     ```typescript
     const timeouts = await getSeasonTimeouts(this.prisma, turnToClaim.id);
     const submissionTimeoutMinutes = turnToClaim.type === 'WRITING'
         ? timeouts.writingTimeoutMinutes
         : timeouts.drawingTimeoutMinutes;
     ```

**Key Implementation Details:**
- Located hardcoded values on line 169 in `src/events/direct-message-handler.ts`
- The logic now dynamically retrieves season-specific timeout values using the utility from subtask 1
- Maintains the same conditional logic (writing vs drawing) but uses dynamic values from season config
- Preserves error handling through the utility's built-in fallback to defaults
- No changes needed to the timeout scheduling logic itself - only the timeout value calculation

**Error Handling:**
- Inherits robust error handling from `getSeasonTimeouts` utility
- Automatic fallback to sensible defaults (24h writing, 72h drawing) if season config is missing
- Maintains existing error handling patterns in the DirectMessageHandler

**Testing Notes:**
- Ready for integration testing with different season configurations
- Should verify both writing and drawing turn types use correct timeout values
- Should test fallback behavior when season config is missing or invalid
</info added on 2025-05-25T16:55:41.650Z>

## 4. Refine Error Handling and Add Comprehensive Tests [done]
### Dependencies: 37.1, 37.2, 37.3
### Description: Review the implementations in subtasks 1, 2, and 3 to ensure error handling and fallback mechanisms are robust. Add any missing unit tests for the utility and integration tests for the services/handlers to cover various scenarios, including edge cases with season configuration.
### Details:
Review the utility function (subtask 1) to confirm defaults are applied correctly for all missing/invalid cases. Review `TurnOfferingService` (subtask 2) and `direct-message-handler.ts` (subtask 3) to ensure they correctly use the utility's output and handle any unexpected issues (though the utility should minimize these). Write additional unit tests for the utility if gaps were found in subtask 1. Write integration tests that simulate games with different season configurations (valid, missing keys, invalid values) and verify that claim and submission deadlines are calculated correctly in both `TurnOfferingService` and `direct-message-handler.ts`.
<info added on 2025-05-25T22:08:04.764Z>
Reviews of the utility (37.1), TurnOfferingService (37.2), and DirectMessageHandler (37.3) are complete. The utility is robust and well-tested. TurnOfferingService integration is correct and tested. DirectMessageHandler integration is correct but requires additional comprehensive integration tests for various timeout configurations and edge cases. Remaining work is to add these specific integration tests for DirectMessageHandler and edge cases for both services, and verify end-to-end timeout behavior.
</info added on 2025-05-25T22:08:04.764Z>
<info added on 2025-05-25T22:15:09.240Z>
Task 37.4 is now complete.

Final Verification Summary:

All Tests Passing:
- seasonConfig utility: 20/20 tests passing
- TurnOfferingService integration: 2/2 tests passing
- DirectMessageHandler integration: 13/13 tests passing (including 4 new comprehensive timeout tests)

Comprehensive Integration Tests Added:
1. Custom writing timeout test: Verifies 6h custom timeout is correctly applied when claiming writing turns
2. Custom drawing timeout test: Verifies 5d custom timeout is correctly applied when claiming drawing turns
3. Invalid timeout fallback test: Verifies that invalid timeout strings fall back to defaults with proper error handling
4. Null/invalid config fallback test: Verifies that completely invalid config values fall back to defaults

Error Handling Verified:
- All three implementations (seasonConfig utility, TurnOfferingService, DirectMessageHandler) have robust error handling
- Invalid duration strings are properly sanitized and logged
- Database errors are handled gracefully with fallbacks to defaults
- All edge cases are covered with comprehensive test coverage

Integration Verification:
- Timeout calculations are correctly applied in milliseconds to scheduler calls
- Custom timeouts from season config are properly retrieved and used
- Default timeouts are correctly applied when config is missing or invalid
- All services correctly integrate with the seasonConfig utility

The timeout configuration integration is fully implemented, tested, and verified across all services.
</info added on 2025-05-25T22:15:09.240Z>

