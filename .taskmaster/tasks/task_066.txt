# Task ID: 66
# Title: Improve Sentence Turn Claiming Messages and Display
# Status: done
# Dependencies: 5, 9, 10, 37, 62
# Priority: medium
# Description: Refine the user experience during sentence turn claiming by ensuring the initial offer message provides context from the previous turn, removing unnecessary messages, and displaying the correct timeout duration.
# Details:
Analysis has shown that the initial direct message offering a sentence turn (`newTurnAvailable` in `TurnOfferingService.ts`) lacks context from the previous turn (image/text), while claim success messages *do* include this context. This creates an inconsistent user experience.

This task involves modifying the turn offer message to include the previous turn's submission (image for drawing turns, text for writing turns) to provide immediate context to the player being offered the turn.

**Files to Modify:**
1.  `src/lang/strings.ts` - Update the `newTurnAvailable` template.
2.  `src/services/TurnOfferingService.ts` - Modify the `sendTurnOfferDM()` method.

**Implementation Steps:**
1.  Update the `newTurnAvailable` string template in `strings.ts` to include placeholders for the previous turn's content (image/text).
2.  Modify `TurnOfferingService.ts` to fetch the previous turn's submission data within the `sendTurnOfferDM()` method.
3.  Include the fetched previous turn content in the message interpolation when sending the `newTurnAvailable` message.
4.  Implement logic to gracefully handle the edge case for the very first turn of a game, where there is no previous turn.
5.  Ensure the message correctly displays the actual `claim_timeout` value configured for the season (Task 37), formatted using the improved duration display logic (Task 62).
6.  Verify that the message updates correctly when the turn is claimed or expires.
7.  Remove any redundant or unnecessary messages that appear specifically during the *claiming* process (e.g., a separate "Turn claimed!" message that is not needed in the context of the offer message updating).

# Test Strategy:
Manually test claiming a sentence turn in a game.
Verify that the initial direct message offering the turn correctly displays the image (for drawing turns) or text (for writing turns) from the immediately preceding turn's submission. Test this for turns after the first one.
Test claiming the very first turn of a game to ensure it handles the absence of a previous image/text gracefully (e.g., displays nothing or a default placeholder if necessary, but not incorrect content).
Verify that no unnecessary messages are sent or displayed during the claiming process.
Verify that the direct message displays the actual remaining time for the claim timeout, formatted according to the standard (Task 62).
Test the message display as the timeout approaches.
Test claiming the turn successfully.
Test letting the claim timeout expire.

# Subtasks:
## 1. undefined [done]
### Dependencies: None
### Description: Update `newTurnAvailable` string template in `src/lang/strings.ts` to include placeholders for previous turn content.
### Details:


## 2. undefined [done]
### Dependencies: None
### Description: Modify `TurnOfferingService.ts` to fetch the previous turn's submission data within `sendTurnOfferDM()`.
### Details:


## 3. undefined [done]
### Dependencies: None
### Description: Modify `TurnOfferingService.ts` to include the fetched previous turn content in the `newTurnAvailable` message interpolation.
### Details:


## 4. undefined [done]
### Dependencies: None
### Description: Implement logic in `TurnOfferingService.ts` to handle the first turn edge case (no previous turn content).
### Details:


## 5. undefined [done]
### Dependencies: None
### Description: Ensure the message correctly displays the actual claim timeout value and uses the standard duration formatting (Task 62).
### Details:


## 6. undefined [done]
### Dependencies: None
### Description: Verify message updates correctly on claim or timeout.
### Details:


## 7. undefined [done]
### Dependencies: None
### Description: Remove any redundant messages specific to the claiming process.
### Details:


## 8. undefined [done]
### Dependencies: None
### Description: Test the changes thoroughly, covering writing/drawing turns, first turn, claim success, and timeout.
### Details:
<info added on 2025-06-04T00:14:58.281Z>
Successfully completed comprehensive testing of Task 66 implementation. All tests are now passing (649/649).

Test Results:
- Fixed the failing test "should include previous turn context for subsequent turns" by adding a second player to the season (required due to MUST Rule 1: players cannot play twice in the same game)
- All 3 TurnOfferingService integration tests now pass:
  1. ✅ should offer a turn and use season-specific claim timeout for DM and scheduling
  2. ✅ should use default claim timeout if season config value is missing or invalid
  3. ✅ should include previous turn context for subsequent turns
- Complete test suite passes: 649 tests across 41 test files

Implementation Summary:
The core functionality for Task 66 has been successfully implemented and tested:

1. ✅ Updated `newTurnAvailable` string template to include `{previousTurnContext}` placeholder
2. ✅ Enhanced `TurnOfferingService.sendTurnOfferDM()` to fetch and include previous turn content
3. ✅ Implemented smart template selection: `initialTurnOffer` for first turns, `newTurnAvailable` for subsequent turns with context
4. ✅ Added proper formatting for previous turn content based on turn type (writing/drawing)
5. ✅ Fixed TypeScript typing issues and test expectations
6. ✅ Comprehensive test coverage including edge cases

The implementation successfully addresses the inconsistent user experience by ensuring turn offer messages now include the same previous turn context that claim success messages provide.
</info added on 2025-06-04T00:14:58.281Z>

