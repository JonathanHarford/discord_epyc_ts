datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
  // output   = "../prisma/generated"
}

model Player {
  id              String   @id @default(nanoid())
  discordUserId   String   @unique
  name            String
  bannedAt        DateTime? // nullable, indicates if and when a player was banned
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  seasons         PlayersOnSeasons[]
  createdSeasons  Season[]           @relation("CreatedSeasons")
  turns           Turn[] // Relation for turns taken by player

}

model Season {
  id              String   @id @default(nanoid())
  status          String   // e.g., "SETUP", "PENDING", "ACTIVE", "COMPLETED", "TERMINATED"
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  configId        String   @unique
  config          SeasonConfig @relation("SeasonToConfig", fields: [configId], references: [id], onDelete: Cascade)

  games           Game[] // Games belonging to this season
  players         PlayersOnSeasons[]

  creatorId       String
  creator         Player   @relation("CreatedSeasons", fields: [creatorId], references: [id], onDelete: Restrict)

  // Origin tracking for announcements
  guildId         String?  // Discord guild ID where season was created (null for DMs)
  channelId       String?  // Discord channel ID where season was created (null for DMs)

  @@index([status])
  @@index([creatorId])
  @@index([guildId])
}

model PlayersOnSeasons {
  player     Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playerId   String
  season     Season   @relation(fields: [seasonId], references: [id], onDelete: Cascade)
  seasonId   String
  joinedAt   DateTime @default(now())

  @@id([playerId, seasonId])
  @@index([playerId])
  @@index([seasonId])
}

model Game {
  id                 String    @id @default(nanoid())
  status             String    // e.g., "SETUP", "ACTIVE", "COMPLETED", "TERMINATED"
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  completedAt        DateTime? // When the game status becomes "COMPLETED"

  seasonId           String
  season             Season    @relation(fields: [seasonId], references: [id], onDelete: Cascade)

  turns              Turn[]    // One-to-many with Turn

  @@index([status])
  @@index([seasonId])
}

model Turn {
  id            String    @id @default(nanoid())
  turnNumber    Int       // Sequential number of the turn within the game
  type          String    // e.g., "WRITING", "DRAWING"
  status        String    // e.g., "AVAILABLE", "OFFERED", "PENDING", "COMPLETED", "SKIPPED"
  textContent   String?
  imageUrl      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  offeredAt     DateTime? // When the turn was offered
  claimedAt     DateTime? // When /ready was used
  completedAt   DateTime? // When the turn was submitted
  skippedAt     DateTime? // When the player was skipped for this turn

  gameId        String
  game          Game      @relation(fields: [gameId], references: [id], onDelete: Cascade)

  playerId      String?   // Player who took/is taking the turn. Optional if turn is just "AVAILABLE"
  player        Player?   @relation(fields: [playerId], references: [id], onDelete: SetNull)

  previousTurnId String?   @unique // Self-relation for turn chain
  previousTurn  Turn?     @relation("TurnChain", fields: [previousTurnId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  nextTurn      Turn?     @relation("TurnChain")

  @@index([status])
  @@index([type])
  @@index([gameId])
  @@index([playerId])
  @@index([createdAt])
}

model SeasonConfig {
  id                 String    @id @default(nanoid())
  turnPattern        String    @default("writing,drawing")
  claimTimeout       String    @default("1d")
  writingTimeout     String    @default("1d")
  writingWarning     String    @default("1m")
  drawingTimeout     String    @default("1d")
  drawingWarning     String    @default("10m")
  openDuration       String    @default("7d")
  minPlayers         Int       @default(6)
  maxPlayers         Int       @default(20)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  isGuildDefaultFor  String?   @unique // Discord Guild ID for which this config is the default
  season             Season?   @relation("SeasonToConfig") // Relation name must match the one in Season model
}

model ScheduledJob {
  id              String    @id @default(nanoid())
  jobId           String    @unique // Application job ID (e.g., "season-activation-123")
  fireDate        DateTime  // When the job should execute
  jobType         String    // Type of job (e.g., "season-activation", "turn-timeout")
  jobData         Json?     // Serialized data to pass to callback
  status          String    @default("SCHEDULED") // "SCHEDULED", "EXECUTED", "CANCELLED", "FAILED"
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  executedAt      DateTime? // When job was actually executed
  failureReason   String?   // Error message if job failed

  @@index([status])
  @@index([jobType])
  @@index([fireDate])
  @@index([jobId])
} 