# Task ID: 27
# Title: Refine and Integrate Messaging Layer
# Status: in-progress
# Dependencies: 5
# Priority: medium
# Description: The core components of the messaging layer (`src/messaging/`), including `MessageInstruction`, `MessageAdapter`, and `MessageHelpers`, have been implemented as described in the architecture. However, integration is incomplete; command handlers and services are not yet consistently using these components for generating user-facing messages.

This task is to complete the integration, ensuring all bot replies (DMs, public channel messages, ephemeral messages) are generated by passing a structured `MessageInstruction` payload through the messaging layer's processing logic. This maintains the architectural goal of separating core service logic from platform-specific message formatting.

Architectural Decisions related to this layer:
1. Services should be designed to be chat platform-independent. Core logic should be abstracted from platform-specific APIs.
2. Service methods invoked by commands should return a common, platform-agnostic data structure (e.g., a `MessageInstruction` type). This structure will be translated by a platform-specific adapter (the messaging layer itself or a component it uses).
# Details:
The `MessageInstruction` data structure, `MessageAdapter`, and `MessageHelpers` are implemented. The remaining work involves updating existing code:
- Command handlers need to be updated to use `MessageAdapter.processInstruction()` to generate final message strings.
- Services should be updated to use `MessageHelpers` for creating standardized `MessageInstruction` objects.
- Ensure `MessageHelpers` is correctly exported and accessible.

# Test Strategy:
Verify that all command handlers and relevant service logic now utilize the messaging layer components (`MessageAdapter`, `MessageHelpers`) for message generation. Test various commands and scenarios to ensure:
- `MessageInstruction` objects are correctly created (ideally via `MessageHelpers`).
- `MessageAdapter.processInstruction()` is called by command handlers.
- The final output message is correctly formatted based on the `MessageInstruction` and platform requirements.
- Test with different data payloads within `MessageInstruction` to ensure correct translation and formatting.

# Subtasks:
## 1. undefined [todo]
### Dependencies: None
### Description: Update command handlers (e.g., in `src/commands/`) to use `MessageAdapter.processInstruction()` for generating bot replies instead of manual string formatting or direct `Lang.getRef` calls.
### Details:
<info added on 2025-05-22T21:04:03.196Z>
âœ… COMPLETED: Fixed test failures in `joinSeason.integration.test.ts`

Issue Identified: The mock interaction object in the test was missing required methods and properties that the `MessageAdapter.sendInteractionResponse` method expects:
- Missing `reply()` method
- Missing `followUp()` method
- Missing `replied` and `deferred` properties

Solution Implemented: Updated the mock interaction object in `beforeEach()` to include:
- `reply: vi.fn().mockResolvedValue(undefined)`
- `followUp: vi.fn().mockResolvedValue(undefined)`
- `replied: false`
- `deferred: true` (set to true because the command has `deferType = CommandDeferType.HIDDEN`)

Result: All 5 tests in `joinSeason.integration.test.ts` now pass successfully. The MessageAdapter is correctly calling `interaction.editReply()` for deferred interactions as expected.

Key Learning: When testing commands that use the messaging layer, mock interactions must include all methods and properties that `MessageAdapter.sendInteractionResponse` checks for (`reply`, `editReply`, `followUp`, `replied`, `deferred`). This ensures that the messaging logic is properly exercised and avoids false negatives in integration tests. Using Jest or Vitest, mock functions like `jest.fn()` or `vi.fn()` should be used to simulate these methods and track their calls, as recommended in best practices for mocking in JavaScript testing frameworks[5][2].
</info added on 2025-05-22T21:04:03.196Z>

## 2. undefined [todo]
### Dependencies: None
### Description: Ensure `MessageHelpers` is correctly exported from the messaging layer's index file (`src/messaging/index.ts`) so it can be used by services.
### Details:


## 3. undefined [todo]
### Dependencies: None
### Description: Update relevant service methods (e.g., in `src/services/`) to utilize `MessageHelpers` for constructing `MessageInstruction` objects returned to command handlers.
### Details:


## 4. undefined [todo]
### Dependencies: None
### Description: Perform integration testing to verify the end-to-end flow: services -> MessageInstruction (via Helpers) -> Command Handler -> MessageAdapter -> Final Message Output.
### Details:


