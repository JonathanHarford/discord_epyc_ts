# Task ID: 46
# Title: Implement On-Demand Game Flow and Services
# Status: pending
# Dependencies: 2, 3, 36
# Priority: high
# Description: Implement the full on-demand game flow as specified in ONDEMAND_FLOWS.md, including new database tables, service classes, command handlers, and admin controls.
# Details:
1. Create a new GameConfig table modeled after SeasonConfig, with fields: turn_pattern, writing_timeout, writing_warning, drawing_timeout, drawing_warning, stale_timeout, min_turns, max_turns, return_count, and return_cooldown. 2. Update the Game table: make seasonId nullable, add creatorId, guildId, and lastActivityAt fields. 3. Refactor TurnService to SeasonTurnService and implement OnDemandTurnService for on-demand games. 4. Implement OnDemandGameService to manage the lifecycle of on-demand games, including creation, joining, turn flow, and completion logic (max_turns or stale_timeout). 5. Develop the GameCommand class with /game new, /game play, /game list, and /game show commands, plus an admin subcommand group (config, list, show, kill). 6. Implement a turn flagging system with PAUSED status and admin reaction handling. 7. Ensure game status transitions (SETUP → PENDING → ACTIVE, cycling as players join/play) and enforce joining logic (find soonest-expiring eligible game, respect return policy). 8. Reuse channel config for announcements, completions, and flagged content. 9. Implement turn pattern logic but disable admin modification. 10. Enforce return policy: return_count (extra plays allowed), return_cooldown (turns by others before rejoining). Ensure all new services and commands are integrated with the existing infrastructure and follow established architectural patterns.

# Test Strategy:
- Write unit tests for OnDemandGameService and OnDemandTurnService covering game creation, joining, turn progression, completion, and return policy enforcement.
- Add integration tests for all /game commands, including admin subcommands, verifying correct Discord responses and database state changes.
- Test GameConfig and Game table migrations and ensure backward compatibility with season-based games.
- Simulate full on-demand game flows (creation, joining, playing, flagging, admin intervention) in a staging environment.
- Verify channel announcements and admin notifications are sent to the correct channels as per config.
- Confirm that turn pattern logic is present but not modifiable by admins, and that return policy is strictly enforced.

# Subtasks:
## 1. Design and Implement Database Schema Updates [done]
### Dependencies: None
### Description: Create the new GameConfig table modeled after SeasonConfig with all specified fields. Update the Game table to make seasonId nullable and add creatorId, guildId, and lastActivityAt fields.
### Details:
Ensure the new schema supports on-demand game flows and is optimized for efficient querying and future extensibility.

## 2. Refactor and Develop Turn Services [done]
### Dependencies: 46.1
### Description: Refactor the existing TurnService to SeasonTurnService and implement OnDemandTurnService to handle turn logic for on-demand games.
### Details:
Ensure the new services are modular, follow established patterns, and support both season-based and on-demand game flows.

## 3. Implement OnDemandGameService and Game Lifecycle Logic [done]
### Dependencies: 46.2
### Description: Develop OnDemandGameService to manage the full lifecycle of on-demand games, including creation, joining, turn flow, completion logic, and enforcement of return policy.
### Details:
Integrate with the new GameConfig and Game tables, handle game status transitions, joining logic, and ensure compliance with return_count and return_cooldown policies.
<info added on 2025-05-27T18:30:51.301Z>
ESLint configuration migrated and linting errors resolved. OnDemandGameService implemented covering game creation/joining, return policy, lifecycle management, player listing/details, and best available game finding. OnDemandTurnService implemented covering initial/next turn creation, assignment, submission/completion, and timeout scheduling. Database operations integrated with Prisma. Services follow architectural patterns and include error handling. Implementation is ready for GameCommand development.
</info added on 2025-05-27T18:30:51.301Z>

## 4. Develop GameCommand and Admin Controls [done]
### Dependencies: 46.3
### Description: Implement the GameCommand class with /game new, /game play, /game list, /game show commands, and the admin subcommand group (config, list, show, kill).
### Details:
Ensure commands interact correctly with OnDemandGameService and provide necessary admin controls for configuration and moderation.
<info added on 2025-05-27T18:48:42.139Z>
Starting work. Identified immediate blocking issues: 1) SchedulerService import error (old TurnService reference), 2) Timeout handlers (ClaimTimeoutHandler, SubmissionTimeoutHandler) depend on old TurnService, 3) Prisma type issues implementing TurnTimeoutService in OnDemandTurnService. Immediate plan: Fix SchedulerService dependencies, update timeout handlers, create /game command structure. Progress: Created TurnTimeoutService interface, added dismissOffer to OnDemandTurnService, updated OnDemandTurnService to implement TurnTimeoutService. Currently resolving Prisma type issues and SchedulerService dependencies. Foundation services need import/type issues resolved before command implementation.
</info added on 2025-05-27T18:48:42.139Z>
<info added on 2025-05-27T19:27:26.696Z>
✅ COMPLETED: All 4 missing admin game handler methods implemented. Successfully implemented all 4 missing admin game command handler methods: 1. handleGameConfigCommand() - View/update server's default game configuration (shows current, updates fields, handles GameConfig table ops). 2. handleGameListCommand() - List active and recent games (filters by status, limits results, shows key info). 3. handleGameShowCommand() - Show detailed game information (comprehensive details, turn summary, config, validates guild). 4. handleGameKillCommand() - Terminate active games (validates, prevents re-termination, calls terminateGame(), shows reason). Additional helper method formatGameConfigForDisplay() created. All methods properly integrate with OnDemandGameService, use SimpleMessage, include error handling/validation, and admin-only access is enforced. Minor cleanup needed for pre-existing linter errors (unused data parameters). Task 46.4 is now functionally complete. All admin game commands are implemented and ready for testing.
</info added on 2025-05-27T19:27:26.696Z>

## 5. Integrate Turn Flagging, Channel Config, and Finalize Flow [pending]
### Dependencies: 46.4
### Description: Implement the turn flagging system with PAUSED status, admin reaction handling, reuse channel config for announcements and flagged content, and finalize turn pattern logic (admin modification disabled).
### Details:
Ensure all new features are integrated with existing infrastructure and that game flow transitions and notifications work as specified.

