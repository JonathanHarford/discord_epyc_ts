# Task ID: 13
# Title: Implement Season Next Player Logic
# Status: done
# Dependencies: 5, 9
# Priority: medium
# Description: The core Next Player Logic algorithm for Season Games, as detailed in the PRD (`MUSTs` and `SHOULDs`), implemented in `src/game/gameLogic.ts` within the `selectNextPlayer` function, is now **fully implemented and tested**. This logic determines which player should be OFFERED the next AVAILABLE turn in a specific game, considering who has played, turn types, and avoiding multiple pending turns for one player. Comprehensive unit tests for this logic have been completed, and the logic is ready for integration.
# Details:
The core `selectNextPlayer` function in `src/game/gameLogic.ts` is now fully implemented and tested, providing the foundation for season game turn management.

Comprehensive unit tests for `selectNextPlayer` have been completed and are located in `tests/game/gameLogic.unit.test.ts`. All 17 tests are passing, covering various scenarios and rules, ensuring robustness and correctness.

**Completed Implementation & Testing:**
*   **Main Function:** `selectNextPlayer(gameId, turnType, prisma)` - Fully implemented and tested, covering all specified MUST and implemented SHOULD rules.
*   **Data Structures:** `PlayerTurnStats` and `NextPlayerResult` interfaces defined and used.
*   **MUST Rules Implemented & Tested:**
    *   Player cannot play in the same game twice within a season.
    *   Player cannot have more than one PENDING turn at a time across all season games.
*   **SHOULD Rules Implemented & Tested:**
    *   Players should not get n/2 turns of same type (implemented with threshold logic).
    *   Prefer player with fewest turns of the given type.
    *   Prefer players with fewer pending turns overall.
*   **Tie-Breaking:** Deterministic selection using the lowest player ID.
*   **Database Queries:** Efficiently fetches necessary data (game, season, turns) and calculates player statistics across the season. Handles error conditions and edge cases gracefully.

**Remaining Work:**
*   **SHOULD Rule 1:** Player A should not follow Player B more than once per season (Requires complex cross-game tracking).
*   Integration tests to verify database interactions and overall flow.
*   Integration with the TurnService for actual game turn management.

# Test Strategy:
Implement comprehensive tests as per TECHNICAL_ARCHITECTURE.md:
1.  Comprehensive unit tests for the core logic function `selectNextPlayer` have been completed in `tests/game/gameLogic.unit.test.ts`. These 17 tests cover various scenarios including new games, mid-game states, end-game scenarios, handling pending turns, skipped players, mixed turn types/statuses, error conditions, and edge cases. They verify the correct player is selected according to the PRD rules and implemented logic.
2.  Write integration tests that interact with a test database to ensure the logic functions correctly within the application context, considering database state changes and interactions, and verifying the overall flow.

# Subtasks:
## 1. undefined [done]
### Dependencies: None
### Description: Implement the core selectNextPlayer logic algorithm in src/game/gameLogic.ts, covering MUST rules and implemented SHOULD rules.
### Details:


## 2. undefined [done]
### Dependencies: None
### Description: Write comprehensive unit tests for the selectNextPlayer function.
### Details:


## 3. undefined [done]
### Dependencies: None
### Description: Write integration tests for the next player logic, verifying database interactions and overall flow.
### Details:


## 4. undefined [done]
### Dependencies: None
### Description: Investigate and potentially implement SHOULD Rule 1 (Player A should not follow Player B more than once per season), which requires complex cross-game tracking.
### Details:


## 5. undefined [done]
### Dependencies: None
### Description: Integrate the selectNextPlayer logic with the TurnService for actual game turn management.
### Details:


