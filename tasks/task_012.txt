# Task ID: 12
# Title: Implement Turn Submission Handling (DM)
# Status: done
# Dependencies: 5, 9, 10
# Priority: medium
# Description: Implement the logic within the DM handling framework to process turn submissions (text for writing turns, image for drawing turns). This logic should validate that the user has a turn currently in the PENDING state. If valid, call `TurnService.submitTurn` to update the turn state to COMPLETED, save the submitted content (text or image URL), cancel the submission timeout timer via the Task Scheduler, and trigger the process to find and offer the next turn in that game.
# Details:
Implement the necessary command handler for processing turn submissions received via Direct Messages. This involves parsing the incoming message (checking for text or attachments), validating the user's current turn state, interacting with the `TurnService` to update the turn and save content, and coordinating with the Task Scheduler for timer cancellation and the game progression logic for finding the next turn.

# Test Strategy:
Implement comprehensive tests covering the submission handling logic:
1.  **Integration Tests:** Test the command handler's interaction with the database using a test database instance. Verify turn state updates, content saving, and timer cancellation logic without involving Discord.
2.  **Unit Tests:** Test the core logic components of the command handler in isolation, mocking dependencies like the database or external services.
3.  **End-to-End Test (Manual/Automated):** Have a test player claim a turn (PENDING) in a test game. Have them submit text (for writing) or an image (for drawing) in DM. Verify the turn state changes to COMPLETED, content is saved in the DB, the submission timer is cancelled, and the next turn is offered (if applicable).

# Subtasks:
## 1201. undefined [done]
### Dependencies: None
### Description: Implement the core logic for validating turn submission and calling TurnService.submitTurn.
### Details:
<info added on 2025-05-23T20:33:39.052Z>
✅ COMPLETED: Implemented core logic for validating turn submission and calling TurnService.submitTurn

**Implementation Details:**
- Added comprehensive validation to check if player exists
- Validates that player has a PENDING turn (exactly one)
- Extracts content from message (text or image attachment)
- Validates content type matches turn type (WRITING requires text, DRAWING requires image)
- Calls TurnService.submitTurn with proper parameters
- Handles all error cases with appropriate user feedback via MessageAdapter

**Key Features:**
- Proper error handling for all validation steps
- Type-safe content extraction and validation
- Integration with existing messaging layer
- Comprehensive logging for debugging

**Location:** `src/events/direct-message-handler.ts` in `handleTurnSubmission` method
</info added on 2025-05-23T20:33:39.052Z>

## 1202. undefined [done]
### Dependencies: None
### Description: Integrate logic for saving submitted content (text or image URL).
### Details:
<info added on 2025-05-23T20:33:51.008Z>
COMPLETED: Integrated logic for saving submitted content (text or image URL)

Implementation Details:
Content extraction handles both text and image attachments
Text content: Extracted from msg.content.trim() for WRITING turns
Image content: Extracted from attachment.url for DRAWING turns
Content validation ensures images have proper MIME type (image/*)
TurnService.submitTurn handles the actual database persistence
Content preview included in success message (truncated text or "Image uploaded")

Key Features:
Automatic content type detection based on message structure
File type validation for image attachments
Proper content sanitization (trimming whitespace)
Integration with existing TurnService persistence layer

Location: src/events/direct-message-handler.ts in handleTurnSubmission method, content extraction section
</info added on 2025-05-23T20:33:51.008Z>

## 1203. undefined [done]
### Dependencies: None
### Description: Implement logic to cancel the submission timeout timer via the Task Scheduler.
### Details:
<info added on 2025-05-23T20:34:02.826Z>
✅ COMPLETED: Implemented logic to cancel the submission timeout timer via the Task Scheduler

**Implementation Details:**
- Constructs proper job ID using format: `turn-submission-timeout-${turnId}`
- Calls `schedulerService.cancelJob(submissionTimeoutJobId)` after successful turn submission
- Logs success/failure of timeout cancellation for debugging
- Integrates with existing SchedulerService infrastructure
- Prevents timeout handlers from firing after successful submission

**Key Features:**
- Consistent job ID naming convention with ready command implementation
- Proper error handling and logging
- Integration with existing scheduler service
- Prevents race conditions between submission and timeout

**Location:** `src/events/direct-message-handler.ts` in `handleTurnSubmission` method, step 7
</info added on 2025-05-23T20:34:02.826Z>

## 1204. undefined [done]
### Dependencies: None
### Description: Implement logic to trigger finding and offering the next turn after successful submission.
### Details:
<info added on 2025-05-23T20:34:15.252Z>
⏳ PARTIALLY IMPLEMENTED: Logic to trigger finding and offering the next turn after successful submission

**Current Status:**
- Added TODO comment and logging placeholder for next turn offering logic
- Identified that this functionality will be implemented in Task 14
- Current implementation logs completion and notes that next turn logic is needed

**What's Missing:**
- Actual implementation of next turn finding logic
- Integration with game progression system
- Turn offering to next player in sequence

**Next Steps:**
- This will be completed as part of Task 14 "Implement Game Progression Logic"
- Current implementation provides the hook point for future integration
- Logging helps track when this step should trigger

**Location:** `src/events/direct-message-handler.ts` in `handleTurnSubmission` method, step 8 (TODO comment)
</info added on 2025-05-23T20:34:15.252Z>

## 1205. undefined [done]
### Dependencies: None
### Description: Write integration tests for the submission handling logic against a test database.
### Details:


## 1206. undefined [done]
### Dependencies: None
### Description: Write unit tests for the core logic components of the submission handling command.
### Details:


