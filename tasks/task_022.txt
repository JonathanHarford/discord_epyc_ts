# Task ID: 22
# Title: Implement Admin Command: Terminate Season
# Status: in-progress
# Dependencies: 2, 5
# Priority: medium
# Description: Implement the `/admin terminate season:<id>` slash command handler in `src/commands/chat`. This handler should include permission checks to ensure only authorized users can use it. It should call the `SeasonService` to mark the specified season as TERMINATED in the database and potentially clean up or mark related games/turns appropriately.
# Details:
As per TECHNICAL_ARCHITECTURE.md, this command implementation requires both integration tests against a test database and unit tests for the core logic.

# Test Strategy:
Implement integration tests that use a test database to verify the command handler's interaction with the `SeasonService` and database state changes (season status, related entities). Implement unit tests for the permission checks and any specific logic within the command handler itself, mocking dependencies like the `SeasonService`. Also, perform manual testing using the `/admin terminate season` command with a test season as an admin to verify the season state changes to TERMINATED in the database. Manually test using the command without admin permissions and verify it is rejected.

# Subtasks:
## 1. undefined [done]
### Dependencies: None
### Description: Implement the core logic for the `/admin terminate season` command handler, including permission checks.
### Details:
<info added on 2025-05-23T05:47:19.145Z>
Core logic for the `/admin terminate season` command handler has been implemented and integrated as follows:

- Created `src/commands/chat/admin-command.ts` with a structured command definition using `SlashCommandBuilder`, registering the `/admin terminate season <id>` subcommand group and required string option for the season identifier.
- Permission checks are enforced using the `Config.developers.includes(intr.user.id)` pattern, mirroring the approach used in the DevCommand for consistency and maintainability. Unauthorized users receive a language-keyed error message, ensuring clear feedback and localization support.
- The handler integrates with `SeasonService.terminateSeason()`, initializing all required dependencies (including `TurnService`, `SchedulerService`, and the shared Prisma client) within the `execute()` method to ensure proper context and resource management.
- Comprehensive error handling is implemented with try-catch blocks, contextual logging (including seasonId, user, and guild), and fallback to generic error messages with error codes for easier debugging and support.
- All admin-related messages and validation responses use language keys defined in `lang/lang.en-US.json` and referenced via `LangKeys.Commands.Admin.*`, with new keys added for admin-only validation and command descriptions.
- The command is exported and registered in both `src/commands/chat/index.ts` and `src/commands/metadata.ts`, ensuring it is available for deployment and registration as a Discord slash command.
- Message responses are handled through `MessageAdapter.processInstruction()` for consistency across the bot's command responses.

This implementation follows Discord's best practices for command handling, permission validation, and modular service integration[1][2][4].
</info added on 2025-05-23T05:47:19.145Z>

## 2. undefined [done]
### Dependencies: None
### Description: Implement integration tests for the `/admin terminate season` command handler against a test database.
### Details:
<info added on 2025-05-23T15:17:02.910Z>
The integration tests for the `/admin terminate season` command handler have been fully implemented and verified to work correctly. These tests are located in the file `tests/commands/chat/adminCommand.integration.test.ts` and consist of 7 passing tests with a total execution time of 192ms.

**Test Coverage Summary:**

- **Permission Checks:** Two tests ensure that non-admin users are denied access without any database changes, while admin users are granted access with appropriate database updates.

- **Terminate Season Command:** Four tests cover successful termination of an active season (including marking related games as TERMINATED), handling attempts to terminate non-existent or already terminated seasons, and graceful handling of database errors such as Prisma validation exceptions.

- **Command Structure:** One test verifies proper error response for unknown subcommands.

**Database Integration:**

- Tests utilize the real Prisma client connected to a test database.
- Proper setup and teardown procedures are implemented, including transaction cleanup to maintain test isolation.
- Actual database state changes are verified, including updates to related entities like games.

**Error Handling:**

- Permission validation is confirmed to work correctly.
- Service layer error propagation and database constraint violation handling are tested.
- Validation of invalid inputs is also covered.

These integration tests follow best practices by testing real interactions with the database rather than mocks, ensuring that the command handler works as expected in a realistic environment. This approach aligns with recommended integration testing strategies that emphasize verifying the full flow from API call to database changes, thereby reducing the risk of undetected issues in production.[1][2][3][4]
</info added on 2025-05-23T15:17:02.910Z>

## 3. undefined [in-progress]
### Dependencies: None
### Description: Implement unit tests for the logic within the `/admin terminate season` command handler.
### Details:


